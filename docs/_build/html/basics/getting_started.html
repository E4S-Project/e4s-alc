<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Getting Started &mdash; E4S-alc vNot set documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/main.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Basic Usage" href="basic_usage.html" />
    <link rel="prev" title="Introduction" href="introduction.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            E4S-alc
          </a>
              <div class="version">
                vNot set
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#system-prerequisites">System Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="#installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#quick-example">Quick Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#workflow-stages">Workflow Stages</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#base-stage">Base Stage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#system-stage">System Stage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#spack-stage">Spack Stage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#finalize-stage">Finalize Stage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#running-the-example-image">Running the example image</a></li>
<li class="toctree-l2"><a class="reference internal" href="#how-it-works">How It Works</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="basic_usage.html">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="yaml_format.html">YAML Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_101.html">Tutorial: <code class="docutils literal notranslate"><span class="pre">e4s-alc</span></code> 101</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_matrix.html">Tutorial: <code class="docutils literal notranslate"><span class="pre">e4s-alc</span></code> matrices</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/using_spack_yaml.html">Using spack.yaml</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/using_modules_yaml.html">Using modules.yaml</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/using_a_buildcache.html">Using a buildcache</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/creating_a_buildcache.html">Creating a buildcache</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">General</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../general/use_cases.html">Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../general/contributing.html">Contributing</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">E4S-alc</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Getting Started</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/basics/getting_started.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="getting-started">
<h1><a class="toc-backref" href="#id1" role="doc-backlink">Getting Started</a><a class="headerlink" href="#getting-started" title="Permalink to this heading"></a></h1>
<p>This guide will walk you through the basics of using our tool.
We’ll cover everything from system prerequisites to how the software works.</p>
<nav class="contents" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#getting-started" id="id1">Getting Started</a></p>
<ul>
<li><p><a class="reference internal" href="#system-prerequisites" id="id2">System Prerequisites</a></p></li>
<li><p><a class="reference internal" href="#installation" id="id3">Installation</a></p></li>
<li><p><a class="reference internal" href="#quick-example" id="id4">Quick Example</a></p></li>
<li><p><a class="reference internal" href="#workflow-stages" id="id5">Workflow Stages</a></p>
<ul>
<li><p><a class="reference internal" href="#base-stage" id="id6">Base Stage</a></p></li>
<li><p><a class="reference internal" href="#system-stage" id="id7">System Stage</a></p></li>
<li><p><a class="reference internal" href="#spack-stage" id="id8">Spack Stage</a></p></li>
<li><p><a class="reference internal" href="#finalize-stage" id="id9">Finalize Stage</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#running-the-example-image" id="id10">Running the example image</a></p></li>
<li><p><a class="reference internal" href="#how-it-works" id="id11">How It Works</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="system-prerequisites">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">System Prerequisites</a><a class="headerlink" href="#system-prerequisites" title="Permalink to this heading"></a></h2>
<p>Before installing and running this program, make sure that your system meets the following prerequisites:</p>
<ol class="arabic">
<li><p><code class="docutils literal notranslate"><span class="pre">make</span></code>: This utility is available in the majority of Unix-like operating systems by default. If it’s not installed on your system, you can install it from the official package repository. For example, on Debian-based distributions, you can use <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt</span> <span class="pre">install</span> <span class="pre">make</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">wget</span></code> or <code class="docutils literal notranslate"><span class="pre">curl</span></code>: These are frequently used command-line tools for sending HTTP requests. Most Unix-based systems include them by default. If they are not installed, you can install either of them using your system’s package manager. For instance, <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt</span> <span class="pre">install</span> <span class="pre">wget</span></code> or <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt</span> <span class="pre">install</span> <span class="pre">curl</span></code>.</p></li>
<li><p><strong>Container backend</strong> (<code class="docutils literal notranslate"><span class="pre">docker</span></code>, <code class="docutils literal notranslate"><span class="pre">podman</span></code>, or <code class="docutils literal notranslate"><span class="pre">singularity</span></code>): The program requires a container backend to run. You can choose between Docker, Podman, or Singularity. Please follow the official installation instructions for the particular backend you choose to install:</p>
<blockquote>
<div><ul class="simple">
<li><p>For Docker: <a class="reference external" href="https://docs.docker.com/engine/install/">https://docs.docker.com/engine/install/</a></p></li>
<li><p>For Podman: <a class="reference external" href="https://podman.io/getting-started/installation">https://podman.io/getting-started/installation</a></p></li>
<li><p>For Singularity: <a class="reference external" href="https://sylabs.io/guides/3.0/user-guide/installation.html">https://sylabs.io/guides/3.0/user-guide/installation.html</a></p></li>
</ul>
</div></blockquote>
</li>
<li><p><strong>Internet connection</strong>: The program needs an active internet connection to function correctly. Please ensure your device is connected to the internet before initializing the program.</p></li>
</ol>
<p>Please keep in mind that to install the aforementioned system prerequisites and to run the program itself, you may require administrative (<code class="docutils literal notranslate"><span class="pre">sudo</span></code>) rights on your system.</p>
</section>
<section id="installation">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Installation</a><a class="headerlink" href="#installation" title="Permalink to this heading"></a></h2>
<p>To install <code class="docutils literal notranslate"><span class="pre">e4s-alc</span></code>, you need to perform these commands in terminal:</p>
<ol class="arabic simple">
<li><p>Clone the E4S-alc repository from GitHub using the command below:</p></li>
</ol>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/E4S-Project/e4s-alc.git
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Navigate to the cloned directory and run the <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">install</span></code> command:</p></li>
</ol>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>e4s-alc<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span>install
</pre></div>
</div>
<p>After running this command, you should see several messages indicating the progress of the installation:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Downloading Miniconda...Complete!</span>
<span class="go">Installing python packages...Complete!</span>
<span class="go">Installing e4s-alc through pip...Complete!</span>
</pre></div>
</div>
<p>These messages show that the Makefile is automatically performing several steps: downloading Miniconda, installing some Python packages required for <code class="docutils literal notranslate"><span class="pre">e4s-alc</span></code>, and then installing <code class="docutils literal notranslate"><span class="pre">e4s-alc</span></code> itself using <code class="docutils literal notranslate"><span class="pre">pip</span></code>, the Python package installer.</p>
<ol class="arabic simple" start="3">
<li><p>Finally, you’re instructed to add <code class="docutils literal notranslate"><span class="pre">e4s-alc</span></code> to your PATH environment variable. You can accomplish this by running the following command:</p></li>
</ol>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/e4s-alc-v1.0.0/bin:<span class="nv">$PATH</span>
</pre></div>
</div>
<p>All together</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/E4S-Project/e4s-alc.git
<span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>e4s-alc<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>make<span class="w"> </span>install
<span class="gp">$ </span><span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/e4s-alc-v1.0.0/bin:<span class="nv">$PATH</span>
</pre></div>
</div>
<p>And with that, installation is complete! You should now be able to use <code class="docutils literal notranslate"><span class="pre">e4s-alc</span></code> from your terminal. Remember to run the export command in each new terminal session, or add it to your <code class="docutils literal notranslate"><span class="pre">.bashrc</span></code> or <code class="docutils literal notranslate"><span class="pre">.bash_profile</span></code> file to make this change permanent.</p>
</section>
<section id="quick-example">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Quick Example</a><a class="headerlink" href="#quick-example" title="Permalink to this heading"></a></h2>
<p>The following command creates a Dockerfile using an <code class="docutils literal notranslate"><span class="pre">ubuntu:22.04</span></code> base image preconfigured to install Spack and download <code class="docutils literal notranslate"><span class="pre">zlib</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>e4s-alc<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--image<span class="w"> </span>ubuntu:22.04<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--spack-package<span class="w"> </span>zlib
</pre></div>
</div>
<p>The corresponding Dockerfile is shown below. You may notice that the Dockerfile has indented syntax (Docker doesn’t recommend this formatting but it provides readability) and is broken up into multiple stages, we’ll break this Dockerfile down in the following section.</p>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="c"># Base Stage</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">ubuntu:22.04</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">base-stage</span>

<span class="w">        </span>#<span class="w"> </span>Set<span class="w"> </span>up<span class="w"> </span>the<span class="w"> </span>environment
<span class="w">        </span>ENV<span class="w"> </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
<span class="w">        </span>ENV<span class="w"> </span><span class="nv">PATH</span><span class="o">=</span>/spack/bin:<span class="nv">$PATH</span>

<span class="c"># System Stage</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">base-stage</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">system-stage</span>

<span class="w">        </span>#<span class="w"> </span>Install<span class="w"> </span>OS<span class="w"> </span>packages
<span class="w">        </span>RUN<span class="w"> </span>apt-get<span class="w"> </span>update
<span class="w">        </span>RUN<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>build-essential<span class="w"> </span>ca-certificates<span class="w"> </span>coreutils<span class="w"> </span>curl<span class="w"> </span>file<span class="w"> </span><span class="se">\</span>
<span class="w">                </span>environment-modules<span class="w"> </span>gfortran<span class="w"> </span>git<span class="w"> </span>gpg<span class="w"> </span>lsb-release<span class="w"> </span>vim<span class="w"> </span>python3<span class="w"> </span><span class="se">\</span>
<span class="w">                </span>python3-distutils<span class="w"> </span>python3-venv<span class="w"> </span>unzip<span class="w"> </span>zip<span class="w"> </span>cmake

<span class="c"># Spack Stage</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">system-stage</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">spack-stage</span>

<span class="w">        </span>#<span class="w"> </span>Install<span class="w"> </span>Spack<span class="w"> </span>version<span class="w"> </span><span class="m">0</span>.20.1
<span class="w">        </span>RUN<span class="w"> </span>curl<span class="w"> </span>-L<span class="w"> </span>https://github.com/spack/spack/releases/download/v0.20.1/spack-0.20.1.tar.gz<span class="w"> </span>-o<span class="w"> </span>/spack.tar.gz
<span class="w">        </span>RUN<span class="w"> </span>gzip<span class="w"> </span>-d<span class="w"> </span>/spack.tar.gz<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>tar<span class="w"> </span>-xf<span class="w"> </span>/spack.tar<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>rm<span class="w"> </span>/spack.tar
<span class="w">        </span>RUN<span class="w"> </span>mv<span class="w"> </span>/spack-0.20.1<span class="w"> </span>/spack<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>.<span class="w"> </span>/spack/share/spack/setup-env.sh
<span class="w">        </span>RUN<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span>/spack/bin:<span class="nv">$PATH</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>~/.bashrc

<span class="w">        </span>#<span class="w"> </span>Setup<span class="w"> </span>spack<span class="w"> </span>and<span class="w"> </span>modules<span class="w"> </span>environment
<span class="w">        </span>RUN<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;. /etc/profile.d/modules.sh&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/etc/profile.d/setup-env.sh
<span class="w">        </span>RUN<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;. /spack/share/spack/setup-env.sh&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/etc/profile.d/setup-env.sh
<span class="w">        </span>RUN<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;export MODULEPATH=\$(echo \$MODULEPATH | cut -d&#39;:&#39; -f1)&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/etc/profile.d/setup-env.sh
<span class="w">        </span>RUN<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;spack env activate main&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/etc/profile.d/setup-env.sh

<span class="w">        </span>#<span class="w"> </span>Add<span class="w"> </span>modules.yaml<span class="w"> </span>file
<span class="w">        </span>RUN<span class="w"> </span>curl<span class="w"> </span>https://www.nic.uoregon.edu/~cfd/e4s-alc/modules.yaml<span class="w"> </span>-o<span class="w"> </span>/spack/etc/spack/modules.yaml

<span class="w">        </span>#<span class="w"> </span>Create<span class="w"> </span>a<span class="w"> </span>Spack<span class="w"> </span>environment
<span class="w">        </span>RUN<span class="w"> </span>spack<span class="w"> </span>env<span class="w"> </span>create<span class="w"> </span>main

<span class="w">        </span>#<span class="w"> </span>Install<span class="w"> </span>Spack<span class="w"> </span>packages
<span class="w">        </span>RUN<span class="w"> </span>.<span class="w"> </span>/spack/share/spack/setup-env.sh<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>spack<span class="w"> </span>env<span class="w"> </span>activate<span class="w"> </span>main<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>spack<span class="w"> </span>install<span class="w"> </span>--add<span class="w"> </span>zlib

<span class="w">        </span>#<span class="w"> </span>Update<span class="w"> </span>compiler<span class="w"> </span>list
<span class="w">        </span>RUN<span class="w"> </span>spack<span class="w"> </span>compiler<span class="w"> </span>find

<span class="c"># Finalize Stage</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">spack-stage</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">finalize-stage</span>

<span class="w">        </span>#<span class="w"> </span>Entrypoint<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>image
<span class="w">        </span>ENTRYPOINT<span class="w"> </span><span class="o">[</span><span class="s2">&quot;/bin/bash&quot;</span>,<span class="w"> </span><span class="s2">&quot;-c&quot;</span>,<span class="w"> </span><span class="s2">&quot;. /etc/profile.d/setup-env.sh &amp;&amp; exec /bin/bash&quot;</span><span class="o">]</span>
</pre></div>
</div>
</section>
<section id="workflow-stages">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Workflow Stages</a><a class="headerlink" href="#workflow-stages" title="Permalink to this heading"></a></h2>
<p>The sequential structure of the Dockerfile is crucial, as each stage is dependent on the one preceding it. For example, if the Base Stage specifies <code class="docutils literal notranslate"><span class="pre">rockylinux:9</span></code> instead of <code class="docutils literal notranslate"><span class="pre">ubuntu:22.04</span></code>, the System Stage would utilize the package manager <code class="docutils literal notranslate"><span class="pre">yum</span></code> instead of <code class="docutils literal notranslate"><span class="pre">apt</span></code>. This structure provides a maintaining dynamic functionality that <code class="docutils literal notranslate"><span class="pre">e4s-alc</span></code> adapts based on the input parameters.</p>
<section id="base-stage">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">Base Stage</a><a class="headerlink" href="#base-stage" title="Permalink to this heading"></a></h3>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="c"># Base Stage</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">ubuntu:22.04</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">base-stage</span>

<span class="w">        </span>#<span class="w"> </span>Set<span class="w"> </span>up<span class="w"> </span>the<span class="w"> </span>environment
<span class="w">        </span>ENV<span class="w"> </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
<span class="w">        </span>ENV<span class="w"> </span><span class="nv">PATH</span><span class="o">=</span>/spack/bin:<span class="nv">$PATH</span>
</pre></div>
</div>
<p>The base stage of the Dockerfile serves as the foundation on which the succeeding stages build. It involves picking an appropriate base image (in this case, <code class="docutils literal notranslate"><span class="pre">Ubuntu:22.04</span></code>) and setting up the necessary environment variables. This stage is vital because it forms the fundamental operating system layer in which applications will run. Any changes to this stage may significantly affect the whole Docker build process and the applications running within the Docker containers.</p>
</section>
<section id="system-stage">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">System Stage</a><a class="headerlink" href="#system-stage" title="Permalink to this heading"></a></h3>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="c"># System Stage</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">base-stage</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">system-stage</span>

<span class="w">        </span>#<span class="w"> </span>Install<span class="w"> </span>OS<span class="w"> </span>packages
<span class="w">        </span>RUN<span class="w"> </span>apt-get<span class="w"> </span>update
<span class="w">        </span>RUN<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>build-essential<span class="w"> </span>ca-certificates<span class="w"> </span>coreutils<span class="w"> </span>curl<span class="w"> </span>file<span class="w"> </span><span class="se">\</span>
<span class="w">                </span>environment-modules<span class="w"> </span>gfortran<span class="w"> </span>git<span class="w"> </span>gpg<span class="w"> </span>lsb-release<span class="w"> </span>vim<span class="w"> </span>python3<span class="w"> </span><span class="se">\</span>
<span class="w">                </span>python3-distutils<span class="w"> </span>python3-venv<span class="w"> </span>unzip<span class="w"> </span>zip<span class="w"> </span>cmake
</pre></div>
</div>
<p>Following the base-stage, the system-stage further builds on the base image by installing additional utilities and packages needed for the specific use-case of the Docker image. These packages provide essential functionalities to enable system operations, developer utilities or runtime of applications. This stage helps to customize the image to meet specific requirements.</p>
</section>
<section id="spack-stage">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">Spack Stage</a><a class="headerlink" href="#spack-stage" title="Permalink to this heading"></a></h3>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="c"># Spack Stage</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">system-stage</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">spack-stage</span>

<span class="w">        </span>#<span class="w"> </span>Install<span class="w"> </span>Spack<span class="w"> </span>version<span class="w"> </span><span class="m">0</span>.20.1
<span class="w">        </span>RUN<span class="w"> </span>curl<span class="w"> </span>-L<span class="w"> </span>https://github.com/spack/spack/releases/download/v0.20.1/spack-0.20.1.tar.gz<span class="w"> </span>-o<span class="w"> </span>/spack.tar.gz
<span class="w">        </span>RUN<span class="w"> </span>gzip<span class="w"> </span>-d<span class="w"> </span>/spack.tar.gz<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>tar<span class="w"> </span>-xf<span class="w"> </span>/spack.tar<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>rm<span class="w"> </span>/spack.tar
<span class="w">        </span>RUN<span class="w"> </span>mv<span class="w"> </span>/spack-0.20.1<span class="w"> </span>/spack<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>.<span class="w"> </span>/spack/share/spack/setup-env.sh
<span class="w">        </span>RUN<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="nb">export</span><span class="w"> </span><span class="nv">PATH</span><span class="o">=</span>/spack/bin:<span class="nv">$PATH</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>~/.bashrc

<span class="w">        </span>#<span class="w"> </span>Setup<span class="w"> </span>spack<span class="w"> </span>and<span class="w"> </span>modules<span class="w"> </span>environment
<span class="w">        </span>RUN<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;. /etc/profile.d/modules.sh&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/etc/profile.d/setup-env.sh
<span class="w">        </span>RUN<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;. /spack/share/spack/setup-env.sh&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/etc/profile.d/setup-env.sh
<span class="w">        </span>RUN<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;export MODULEPATH=\$(echo \$MODULEPATH | cut -d&#39;:&#39; -f1)&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/etc/profile.d/setup-env.sh
<span class="w">        </span>RUN<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;spack env activate main&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/etc/profile.d/setup-env.sh

<span class="w">        </span>#<span class="w"> </span>Add<span class="w"> </span>modules.yaml<span class="w"> </span>file
<span class="w">        </span>RUN<span class="w"> </span>curl<span class="w"> </span>https://www.nic.uoregon.edu/~cfd/e4s-alc/modules.yaml<span class="w"> </span>-o<span class="w"> </span>/spack/etc/spack/modules.yaml

<span class="w">        </span>#<span class="w"> </span>Create<span class="w"> </span>a<span class="w"> </span>Spack<span class="w"> </span>environment
<span class="w">        </span>RUN<span class="w"> </span>spack<span class="w"> </span>env<span class="w"> </span>create<span class="w"> </span>main

<span class="w">        </span>#<span class="w"> </span>Install<span class="w"> </span>Spack<span class="w"> </span>packages
<span class="w">        </span>RUN<span class="w"> </span>.<span class="w"> </span>/spack/share/spack/setup-env.sh<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>spack<span class="w"> </span>env<span class="w"> </span>activate<span class="w"> </span>main<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>spack<span class="w"> </span>install<span class="w"> </span>--add<span class="w"> </span>zlib

<span class="w">        </span>#<span class="w"> </span>Update<span class="w"> </span>compiler<span class="w"> </span>list
<span class="w">        </span>RUN<span class="w"> </span>spack<span class="w"> </span>compiler<span class="w"> </span>find
</pre></div>
</div>
<p>The Spack stage is about setting up the Spack package manager and related dependencies. The Spack manager automates the process of downloading, building, and installing packages along with their dependencies. This stage simplifies the process of managing multiple packages, handling dependencies, and ensuring that the correct versions of packages are used.</p>
</section>
<section id="finalize-stage">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">Finalize Stage</a><a class="headerlink" href="#finalize-stage" title="Permalink to this heading"></a></h3>
<div class="highlight-Dockerfile notranslate"><div class="highlight"><pre><span></span><span class="c"># Finalize Stage</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">spack-stage</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">finalize-stage</span>

<span class="w">        </span>#<span class="w"> </span>Entrypoint<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span>image
<span class="w">        </span>ENTRYPOINT<span class="w"> </span><span class="o">[</span><span class="s2">&quot;/bin/bash&quot;</span>,<span class="w"> </span><span class="s2">&quot;-c&quot;</span>,<span class="w"> </span><span class="s2">&quot;. /etc/profile.d/setup-env.sh &amp;&amp; exec /bin/bash&quot;</span><span class="o">]</span>
</pre></div>
</div>
<p>The finalize stage is the concluding stage in the Dockerfile where the image is finalized for use. This simplifies the process of initializing a Docker container from the final image, making it straightforward to run and handle. It also serves as a point where any cleanup or optimizations can be carried out to reduce the size of the final Docker image.</p>
</section>
</section>
<section id="running-the-example-image">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">Running the example image</a><a class="headerlink" href="#running-the-example-image" title="Permalink to this heading"></a></h2>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>e4s-alc<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--image<span class="w"> </span>ubuntu:22.04<span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--spack-package<span class="w"> </span>zlib
</pre></div>
</div>
<p>Following the completion the above command, a Dockerfile appears in the current directory.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls
<span class="go">Dockerfile</span>
</pre></div>
</div>
<p>Using <code class="docutils literal notranslate"><span class="pre">podman</span></code>, I build and run the image with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>podman<span class="w"> </span>build<span class="w"> </span>.<span class="w"> </span>-t<span class="w"> </span>example-image<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>podman<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>example-image
</pre></div>
</div>
<p>Now I’m in the image. Now let’s check our spack packages with <code class="docutils literal notranslate"><span class="pre">spack</span> <span class="pre">find</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@d67d168212a0:/# </span>spack<span class="w"> </span>find
<span class="go">==&gt; In environment main</span>
<span class="go">==&gt; Root specs</span>
<span class="go">zlib</span>

<span class="go">==&gt; Installed packages</span>
<span class="go">-- linux-ubuntu22.04-zen2 / gcc@11.4.0 --------------------------</span>
<span class="go">zlib@1.2.13</span>
<span class="go">==&gt; 1 installed package</span>
</pre></div>
</div>
<p>Let’s also list our available modules and load <code class="docutils literal notranslate"><span class="pre">zlib</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">root@d67d168212a0:/# </span>module<span class="w"> </span>avail
<span class="go">------- /modulefiles/linux-ubuntu22.04-zen2 -------</span>
<span class="go">zlib/1.2.13</span>

<span class="go">Key:</span>
<span class="go">modulepath</span>
<span class="gp">root@d67d168212a0:/# </span>module<span class="w"> </span>load<span class="w"> </span>zlib
<span class="gp">root@d67d168212a0:/# ls $</span>ZLIB_LIB
<span class="go">libz.a  libz.so  libz.so.1  libz.so.1.2.13  pkgconfig</span>
</pre></div>
</div>
</section>
<section id="how-it-works">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">How It Works</a><a class="headerlink" href="#how-it-works" title="Permalink to this heading"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">e4s-alc</span></code> operates by receiving a set of inputs. Once these inputs are processed, <code class="docutils literal notranslate"><span class="pre">e4s-alc</span></code> initiates the process of pulling the designated base image. Following this, the content of the base image is meticulously analyzed to confirm its compatibility with the succeeding stages.</p>
<p>Upon completion of the analysis, <code class="docutils literal notranslate"><span class="pre">e4s-alc</span></code> shifts into the building phase. It commences the systematic construction of each stage, ensuring that the commands utilised in each stage align correctly with the given inputs and the base image. This iterative construction ensures the resulting Dockerfile maintains compatibility throughout all stages.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="introduction.html" class="btn btn-neutral float-left" title="Introduction" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="basic_usage.html" class="btn btn-neutral float-right" title="Basic Usage" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, OACISS.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>